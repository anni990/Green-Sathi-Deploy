{% extends 'base.html' %}

{% block title %}Chat with Green Sathi{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<style>
    .chat-container {
        height: calc(100vh - 350px);
        min-height: 400px;
    }

    .message-bubble {
        max-width: 80%;
    }

    .user-message {
        background-color: #e2f7df;
        border-radius: 18px 18px 0 18px;
    }

    .bot-message {
        background-color: #f0f0f0;
        border-radius: 18px 18px 18px 0;
    }

    .typing-indicator span {
        animation: blink 1s infinite;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes blink {
        0% {
            opacity: 0.2;
        }

        20% {
            opacity: 1;
        }

        100% {
            opacity: 0.2;
        }
    }

    .farmer-assistant {
        max-width: 150px;
        filter: drop-shadow(0 4px 3px rgba(0, 0, 0, 0.07));
    }

    .voice-ripple {
        width: 55px;
        height: 55px;
        position: absolute;
        border-radius: 50%;
        animation: ripple 1.5s linear infinite;
    }

    @keyframes ripple {
        0% {
            box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.3);
        }

        100% {
            box-shadow: 0 0 0 20px rgba(22, 163, 74, 0);
        }
    }

    .chat-input-container {
        background-color: #ffffff;
        border-top: 1px solid #e5e7eb;
    }

    .tab-button.active {
        color: #15803d;
        border-color: #15803d;
    }

    /* Custom file input styling */
    .custom-file-input::-webkit-file-upload-button {
        visibility: hidden;
    }

    .custom-file-input::before {
        content: 'Select file';
        display: inline-block;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        outline: none;
        white-space: nowrap;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
        color: #374151;
        background-color: white;
    }

    .custom-file-input:hover::before {
        border-color: #9ca3af;
    }

    .custom-file-input:active::before {
        background-color: #f3f4f6;
    }

    /* Formatting for bot messages */
    .bot-message .formatted-message {
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .bot-message .formatted-message strong {
        font-weight: bold;
    }

    .bot-message .formatted-message em {
        font-style: italic;
    }

    .bot-message .formatted-message code {
        font-family: monospace;
        background-color: #f0f0f0;
        padding: 2px 4px;
        border-radius: 3px;
    }

    .bot-message .formatted-message ul {
        list-style-type: disc;
        padding-left: 1.5rem;
        margin: 0.5rem 0;
    }

    .bot-message .formatted-message ol {
        list-style-type: decimal;
        padding-left: 1.5rem;
        margin: 0.5rem 0;
    }

    .bot-message .formatted-message p {
        margin-bottom: 0.5rem;
    }

    /* Voice interaction styles */
    .voice-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
    }

    .voice-button {
        position: relative;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .record-button {
        background-color: #15803d;
        color: white;
    }

    .record-button:hover {
        background-color: #166534;
    }

    .record-button.recording {
        background-color: #dc2626;
        animation: pulse 1.5s infinite;
    }

    .stop-button {
        background-color: #dc2626;
        color: white;
    }

    .stop-button:hover {
        background-color: #b91c1c;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
        100% {
            transform: scale(1);
        }
    }

    .voice-status {
        margin-top: 10px;
        padding: 8px 16px;
        border-radius: 20px;
        display: inline-block;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .status-idle {
        background-color: #f3f4f6;
        color: #4b5563;
    }

    .status-listening {
        background-color: #dcfce7;
        color: #166534;
        animation: pulse 1.5s infinite;
    }

    .status-processing {
        background-color: #dbeafe;
        color: #1e40af;
    }

    .status-speaking {
        background-color: #dbeafe;
        color: #1e40af;
        animation: pulse 1.5s infinite;
    }

    /* Chat History Sidebar */
    .chat-history {
        width: 300px;
        background-color: #f8f9fa;
        border-right: 1px solid #e5e7eb;
        height: calc(100vh - 64px);
        overflow-y: auto;
    }

    .chat-history-item {
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .chat-history-item:hover {
        background-color: #e5e7eb;
    }

    .chat-history-item.active {
        background-color: #e2f7df;
        border-left: 3px solid #15803d;
    }

    .chat-history-item .time {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .chat-history-item .preview {
        font-size: 0.875rem;
        color: #4b5563;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .main-chat-container {
        display: flex;
        height: calc(100vh - 64px);
    }

    .chat-interface {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .plant-diagnosis-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        object-fit: contain;
    }

    .formatted-message img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        object-fit: contain;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-chat-container">
    <!-- Chat History Sidebar -->
    <div class="chat-history ">
        <div class="p-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">Chat History</h3>
        </div>
        <div id="chatHistoryList">
            {% for chat in chat_history %}
            <div class="chat-history-item {% if chat.id == current_chat_id %}active{% endif %}" 
                 data-chat-id="{{ chat.id }}">
                <div class="flex justify-between items-start">
                    <div class="cursor-pointer" onclick="window.location.href='/chat?chat_id={{ chat.id }}&language={{ chat.language }}'">
                        <div class="font-medium text-gray-900">
                            Chat #{{ loop.index }}
                        </div>
                        <div class="time">{{ chat.created_at.strftime('%d %b %Y, %H:%M') }}</div>
                    </div>
                    <div class="flex items-start">
                        <div class="text-sm text-gray-500 mr-2">
                            {{ chat.language|title }}
                        </div>
                        <button 
                            data-chat-id="{{ chat.id }}" 
                            class="delete-chat-btn text-red-500 hover:text-red-700">
                            <i class="fa-solid fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="preview mt-1">
                    {% if chat.messages %}
                        {% if '<img' in chat.messages[-1].text %}
                            {% if chat.messages[-1].sender == 'user' %}
                                [Plant Image] Plant diagnosis request
                            {% else %}
                                {{ chat.messages[-1].text|striptags|truncate(50) }}
                            {% endif %}
                        {% else %}
                            {{ chat.messages[-1].text|striptags|truncate(50) }}
                        {% endif %}
                    {% else %}
                        New chat
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div class="chat-interface">
        <div class="relative">
            <!-- Character Avatar -->
            <!-- <div class="character-container absolute top-0 right-40 -mt-12 hidden md:block">
                <img src="{{ url_for('static', filename='images/chatbot-img.png') }}" alt="Farmer Assistant"
                    class="farmer-assistant">
            </div> -->

            <!-- Chat Interface -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden" id="chatInterface">
                <!-- Chat Header -->
                <div class="farmer-gradient text-white p-4">
                    <div class="flex items-center">
                        <div>
                            <h2 class="text-lg font-semibold">Green Sathi - Your AI Farming Assistant</h2>
                            <p class="text-xs text-white text-opacity-80">
                                Current language: <span id="currentLanguage" class="font-semibold">{{ language|title }}</span>
                            </p>
                        </div>
                        <div class="ml-auto flex items-center space-x-2">
                            <button id="newChatButton"
                                class="bg-white bg-opacity-20 text-white px-3 py-1 text-sm rounded-md border border-white border-opacity-30">
                                <i class="fa-solid fa-plus mr-1"></i> New Chat
                            </button>
                            <select id="languageSelector"
                                class="bg-white bg-opacity-20 text-black border border-white border-opacity-30 rounded-md text-sm p-1">
                                <option value="english" {% if language=='english' %}selected{% endif %}>English</option>
                                <option value="hindi" {% if language=='hindi' %}selected{% endif %}>हिंदी</option>
                                <option value="bengali" {% if language=='bengali' %}selected{% endif %}>বাংলা</option>
                                <option value="marathi" {% if language=='marathi' %}selected{% endif %}>मराठी</option>
                                <option value="tamil" {% if language=='tamil' %}selected{% endif %}>தமிழ்</option>
                                <option value="telugu" {% if language=='telugu' %}selected{% endif %}>తెలుగు</option>
                                <option value="kannada" {% if language=='kannada' %}selected{% endif %}>ಕನ್ನಡ</option>
                                <option value="gujarati" {% if language=='gujarati' %}selected{% endif %}>ગુજરાતી</option>
                                <option value="urdu" {% if language=='urdu' %}selected{% endif %}>اردو</option>
                                <option value="malayalam" {% if language=='malayalam' %}selected{% endif %}>മലയാളം</option>
                                <option value="punjabi" {% if language=='punjabi' %}selected{% endif %}>ਪੰਜਾਬੀ</option>
                                <option value="bhojpuri" {% if language=='bhojpuri' %}selected{% endif %}>भोजपुरी</option>
                                <option value="bundelkhandi" {% if language=='bundelkhandi' %}selected{% endif %}>बुंदेलखंडी</option>
                                <option value="haryanvi" {% if language=='haryanvi' %}selected{% endif %}>हरियाणवी</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chatMessages" class="chat-container p-4 overflow-y-auto">
                    <!-- Welcome Message (show only for new chats) -->
                    {% if messages %}
                        {% for message in messages %}
                            {% if message.sender == 'user' %}
                            <!-- User Message -->
                            <div class="flex justify-end mb-4">
                                <div class="message-bubble user-message p-3">
                                    {% if message.input_type == 'image' or '<img' in message.text %}
                                        <div class="formatted-message">{{ message.text|safe }}</div>
                                    {% else %}
                                        <p>{{ message.text }}</p>
                                    {% endif %}
                                    <p class="text-xs text-gray-500 text-right mt-1">
                                        {{ message.timestamp.strftime('%H:%M') }}
                                        {% if message.input_type != 'text' %}
                                        • {{ message.input_type }}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            {% else %}
                            <!-- Bot Response -->
                            <div class="flex mb-4">
                                <div class="message-bubble bot-message p-3">
                                    <div class="formatted-message">{{ message.text|safe }}</div>
                                    <p class="text-xs text-gray-500 mt-1">{{ message.timestamp.strftime('%H:%M') }}</p>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                    <!-- Default welcome message for new chats -->
                    <div class="flex mb-4">
                        <div class="message-bubble bot-message p-3">
                            <div class="formatted-message">
                                {% if language == 'english' %}
                                    Hello! I'm your Green Sathi. How can I help you with your farming questions today?
                                {% elif language == 'hindi' %}
                                    नमस्ते! मैं आपका ग्रीन साथी हूँ। आज मैं आपकी खेती संबंधित प्रश्नों में कैसे मदद कर सकता हूँ?
                                {% elif language == 'bengali' %}
                                    নমস্কার! আমি আপনার গ্রীন সাথী। আজ আমি আপনার কৃষি সংক্রান্ত প্রশ্নগুলিতে কীভাবে সাহায্য করতে পারি?
                                {% elif language == 'marathi' %}
                                    नमस्कार! मी तुमचा ग्रीन साथी आहे. आज मी तुम्हाला तुमच्या शेती संबंधित प्रश्नांमध्ये कशी मदत करू शकतो?
                                {% elif language == 'tamil' %}
                                    வணக்கம்! நான் உங்கள் கிரீன் சாதி. இன்று உங்கள் விவசாய கேள்விகளில் நான் எப்படி உதவ முடியும்?
                                {% elif language == 'telugu' %}
                                    నమస్కారం! నేను మీ గ్రీన్ సాథి. నేడు మీ వ్యవసాయ ప్రశ్నలలో నేను మీకు ఎలా సహాయం చేయగలను?
                                {% elif language == 'kannada' %}
                                    ನಮಸ್ಕಾರ! ನಾನು ನಿಮ್ಮ ಗ್ರೀನ್ ಸಾಥಿ. ಇಂದು ನಿಮ್ಮ ಕೃಷಿ ಪ್ರಶ್ನೆಗಳಲ್ಲಿ ನಾನು ನಿಮಗೆ ಹೇಗೆ ಸಹಾಯ ಮಾಡಬಹುದು?
                                {% elif language == 'gujarati' %}
                                    નમસ્તે! હું તમારો ગ્રીન સાથી છું. આજે હું તમારા ખેતી સંબંધિત પ્રશ્નોમાં કેવી રીતે મદદ કરી શકું છું?
                                {% elif language == 'urdu' %}
                                    سلام! میں آپ کا گرین ساتھی ہوں۔ آج میں آپ کے زرعی سوالات میں کیسے مدد کر سکتا ہوں؟
                                {% elif language == 'malayalam' %}
                                    നമസ്കാരം! ഞാൻ നിങ്ങളുടെ ഗ്രീൻ സാഥി ആണ്. ഇന്ന് നിങ്ങളുടെ കാർഷിക ചോദ്യങ്ങളിൽ എനിക്ക് എങ്ങനെ സഹായിക്കാൻ കഴിയും?
                                {% elif language == 'punjabi' %}
                                    ਸਤਿ ਸ੍ਰੀ ਅਕਾਲ! ਮੈਂ ਤੁਹਾਡਾ ਗ੍ਰੀਨ ਸਾਥੀ ਹਾਂ। ਅੱਜ ਮੈਂ ਤੁਹਾਡੇ ਖੇਤੀਬਾੜੀ ਸੰਬੰਧੀ ਸਵਾਲਾਂ ਵਿੱਚ ਤੁਹਾਡੀ ਕਿਵੇਂ ਮਦਦ ਕਰ ਸਕਦਾ ਹਾਂ?
                                {% elif language == 'bhojpuri' %}
                                    नमस्कार! हम आपके ग्रीन साथी हईं। आज हम आपके खेती से जुड़ल सवालन में केही मदद कर सकत बानी?
                                {% elif language == 'bundelkhandi' %}
                                    नमस्कार! हम आपके ग्रीन साथी हैं। आज हम आपके खेती से जुड़े सवालों में कैसे मदद कर सकते हैं?
                                {% elif language == 'haryanvi' %}
                                    नमस्कार! मैं थारा ग्रीन साथी हूँ। आज मैं थारे खेती से जुड़े सवालां में किस तरह मदद कर सकूं?
                                {% else %}
                                    नमस्ते! मैं आपका ग्रीन साथी हूँ। आज मैं आपकी खेती संबंधित प्रश्नों में कैसे मदद कर सकता हूँ?
                                {% endif %}
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Green Sathi</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Typing Indicator (Hidden by default) -->
                    <div id="typingIndicator" class="flex mb-4 hidden">
                        <div class="message-bubble bot-message p-3">
                            <div class="typing-indicator flex space-x-1">
                                <span>•</span><span>•</span><span>•</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="chat-input-container p-3">
                    <!-- Input Type Tabs -->
                    <div class="flex border-b border-gray-200 mb-3">
                        <button type="button" id="tabText"
                            class="tab-button active flex items-center py-2 px-4 border-b-2 text-sm font-medium">
                            <i class="fa-solid fa-comment mr-2"></i> Text
                        </button>
                        <button type="button" id="tabVoice"
                            class="tab-button flex items-center py-2 px-4 border-b-2 border-transparent text-sm font-medium text-gray-500">
                            <i class="fa-solid fa-microphone mr-2"></i> Voice
                        </button>
                        <button type="button" id="tabImage"
                            class="tab-button flex items-center py-2 px-4 border-b-2 border-transparent text-sm font-medium text-gray-500">
                            <i class="fa-solid fa-camera mr-2"></i> Image
                        </button>
                        <a href="{{ url_for('soil_report') }}" 
                            class="tab-button flex items-center py-2 px-4 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                            <i class="fa-solid fa-file-invoice mr-2"></i> Soil Report Analysis
                        </a>
                        <a href="{{ url_for('weather') }}" 
                            class="tab-button flex items-center py-2 px-4 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                            <i class="fa-solid fa-cloud-sun-rain mr-2"></i> Weather Analysis
                        </a>
                    </div>

                    <!-- Text Input (Default) -->
                    <div id="inputText" class="input-section">
                        <form id="textForm" class="flex">
                            <input type="text" id="messageInput" placeholder="Type your farming question..."
                                class="flex-grow block border-gray-300 rounded-l-md shadow-sm focus:ring-farmer-green-500 focus:border-farmer-green-500 sm:text-sm h-10">
                            <button type="submit"
                                class="bg-farmer-green-600 hover:bg-farmer-green-700 text-white px-4 rounded-r-md">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </form>
                        <div class="mt-2 flex items-center">
                            <label class="flex items-center text-sm text-gray-600 mr-4">
                                <input type="checkbox" id="readAloud" class="mr-1 rounded text-farmer-green-600">
                                Read aloud
                            </label>
                        </div>
                    </div>

                    <!-- Voice Input -->
                    <div id="inputVoice" class="input-section hidden">
                        <div class="text-center py-4">
                            <div class="voice-controls">
                                <button type="button" id="recordButton" 
                                    class="voice-button record-button">
                                    <i id="micIcon" class="fa-solid fa-microphone text-xl"></i>
                                </button>
                                <button type="button" id="stopAudioButton" 
                                    class="voice-button stop-button hidden">
                                    <i class="fa-solid fa-stop text-xl"></i>
                                </button>
                            </div>
                            <div class="mt-3">
                                <span id="recordStatus" class="voice-status status-idle">Press to start recording</span>
                            </div>
                            <!-- Reload from Server with a button having proper styling using tailwind css-->
                            <button onclick="location.reload(true);" class="bg-farmer-green-600 hover:bg-farmer-green-700 text-white py-1 px-2 rounded-md float-right mb-2">
                                <i class="fa-solid fa-stop mr-1"></i> Stop AI
                            </button>
                        </div>
                    </div>

                    <!-- Image Upload -->
                    <div id="inputImage" class="input-section hidden">
                        <form id="imageForm" class="text-center py-2">
                            <label class="block mb-3 text-sm font-medium text-gray-700">Upload a photo of your plant</label>
                            <input type="file" id="imageInput" name="image" accept="image/*" class="custom-file-input mb-3">
                            <p class="text-xs text-gray-500 mb-3">For best results, take a clear, well-lit photo of the affected
                                plant part</p>
                            <button type="submit"
                                class="bg-farmer-green-600 hover:bg-farmer-green-700 text-white py-2 px-4 rounded-md">
                                <i class="fa-solid fa-upload mr-1"></i> Analyze Plant
                            </button>
                        </form>
                    </div>

                    <!-- Soil Report Upload -->
                    <div id="inputSoil" class="input-section hidden">
                        <div class="text-center py-2">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">Soil Report Analysis</h3>
                            <p class="text-gray-600 mb-6">For detailed soil analysis, please use our dedicated soil report analysis tool.</p>
                            <a href="{{ url_for('soil_report') }}" class="bg-farmer-green-600 hover:bg-farmer-green-700 text-white py-2 px-4 rounded-md inline-block">
                                <i class="fa-solid fa-microscope mr-1"></i> Open Soil Report Analysis
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audio Player (Hidden) -->
<audio id="audioPlayer" class="hidden"></audio>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{% endblock %}